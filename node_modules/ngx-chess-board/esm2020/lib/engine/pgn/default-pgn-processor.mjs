import { King } from '../../models/pieces/king';
import { Pawn } from '../../models/pieces/pawn';
import { MoveUtils } from '../../utils/move-utils';
import { AbstractPgnProcessor } from './abstract-pgn-processor';
export class DefaultPgnProcessor extends AbstractPgnProcessor {
    process(board, sourcePiece, destPoint, destPiece) {
        this.currentIndex += 0.5;
        this.pgn += (this.currentIndex % Math.floor(this.currentIndex) === 0) ? (' ' + this.currentIndex + '. ') : ' ';
        let possibleCaptures = [];
        let possibleMoves = [];
        if (destPiece) {
            possibleCaptures = MoveUtils.findPieceByPossibleCapturesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        }
        possibleMoves = MoveUtils.findPieceByPossibleMovesContaining(MoveUtils.formatSingle(destPoint, board.reverted), board, sourcePiece.color).filter(piece => piece.constructor.name === sourcePiece.constructor.name);
        if (sourcePiece instanceof Pawn && !destPiece && possibleCaptures.length === 0) {
            this.pgn += MoveUtils.formatSingle(destPoint, board.reverted);
        }
        else {
            if (sourcePiece instanceof Pawn && destPiece) {
                this.pgn += MoveUtils.formatSingle(sourcePiece.point, board.reverted).substring(0, 1) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
            }
            else {
                if (sourcePiece instanceof King && (Math.abs(sourcePiece.point.col - destPoint.col) === 2)) {
                    if (board.reverted) {
                        this.pgn += destPoint.col < 2
                            ? 'O-O'
                            : 'O-O-O';
                    }
                    else {
                        this.pgn += destPoint.col < 3
                            ? 'O-O-O'
                            : 'O-O';
                    }
                }
                else {
                    if (!(sourcePiece instanceof Pawn) && possibleCaptures.length === 0 && possibleMoves.length < 2) { // Nf3
                        this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatSingle(destPoint, board.reverted);
                    }
                    else {
                        if (possibleMoves && possibleMoves.length === 2 && possibleCaptures.length === 0) { // Nbd7
                            if (this.isEqualByCol(possibleMoves[0], possibleMoves[1])) {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                            else {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                        else {
                            if (possibleCaptures.length > 1) {
                                if ((this.isEqualByCol(possibleCaptures[0], possibleCaptures[1]))) {
                                    this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.reverse(board, sourcePiece.point.row) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                                else {
                                    this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + MoveUtils.formatCol(board, sourcePiece.point.col) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                                }
                            }
                            else {
                                this.pgn += MoveUtils.getFirstLetterPiece(sourcePiece) + 'x' + MoveUtils.formatSingle(destPoint, board.reverted);
                            }
                        }
                    }
                }
            }
        }
        this.pgn = this.pgn.trim();
    }
    resolvePieceByFirstChar(move, piece) {
        return MoveUtils.getFirstLetterPiece(piece) === move;
    }
    isEqualByCol(aPiece, bPiece) {
        return aPiece.point.col === bPiece.point.col;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmYXVsdC1wZ24tcHJvY2Vzc29yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LWNoZXNzLWJvYXJkL3NyYy9saWIvZW5naW5lL3Bnbi9kZWZhdWx0LXBnbi1wcm9jZXNzb3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUdoRCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDbkQsT0FBTyxFQUFFLG9CQUFvQixFQUFFLE1BQU0sMEJBQTBCLENBQUM7QUFFaEUsTUFBTSxPQUFPLG1CQUFvQixTQUFRLG9CQUFvQjtJQUVsRCxPQUFPLENBQ1YsS0FBWSxFQUNaLFdBQWtCLEVBQ2xCLFNBQWdCLEVBQ2hCLFNBQWlCO1FBRWpCLElBQUksQ0FBQyxZQUFZLElBQUksR0FBRyxDQUFDO1FBQ3pCLElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7UUFFL0csSUFBSSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7UUFDMUIsSUFBSSxhQUFhLEdBQUcsRUFBRSxDQUFDO1FBRXZCLElBQUksU0FBUyxFQUFFO1lBQ1gsZ0JBQWdCLEdBQUcsU0FBUyxDQUFDLHFDQUFxQyxDQUM5RCxTQUFTLENBQUMsWUFBWSxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsUUFBUSxDQUFDLEVBQ2pELEtBQUssRUFDTCxXQUFXLENBQUMsS0FBSyxDQUNwQixDQUFDLE1BQU0s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U0FDSjtRQUVELElBQUksQ0FBQyxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUMvQixDQUFDO0lBRU8sdUJBQXVCLENBQUMsSUFBWSxFQUFFLEtBQVk7UUFDdEQsT0FBTyxTQUFTLENBQUMsbUJBQW1CLENBQUMsS0FBSyxDQUFDLEtBQUssSUFBSSxDQUFDO0lBQ3pELENBQUM7SUFFTyxZQUFZLENBQUMsTUFBYSxFQUFFLE1BQWE7UUFDN0MsT0FBTyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsS0FBSyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztJQUNqRCxDQUFDO0NBRUoiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBCb2FyZCB9IGZyb20gJy4uLy4uL21vZGVscy9ib2FyZCc7XHJcbmltcG9ydCB7IEtpbmcgfSBmcm9tICcuLi8uLi9tb2RlbHMvcGllY2VzL2tpbmcnO1xyXG5pbXBvcnQgeyBQYXduIH0gZnJvbSAnLi4vLi4vbW9kZWxzL3BpZWNlcy9wYXduJztcclxuaW1wb3J0IHsgUGllY2UgfSBmcm9tICcuLi8uLi9tb2RlbHMvcGllY2VzL3BpZWNlJztcclxuaW1wb3J0IHsgUG9pbnQgfSBmcm9tICcuLi8uLi9tb2RlbHMvcGllY2VzL3BvaW50JztcclxuaW1wb3J0IHsgTW92ZVV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMvbW92ZS11dGlscyc7XHJcbmltcG9ydCB7IEFic3RyYWN0UGduUHJvY2Vzc29yIH0gZnJvbSAnLi9hYnN0cmFjdC1wZ24tcHJvY2Vzc29yJztcclxuXHJcbmV4cG9ydCBjbGFzcyBEZWZhdWx0UGduUHJvY2Vzc29yIGV4dGVuZHMgQWJzdHJhY3RQZ25Qcm9jZXNzb3Ige1xyXG5cclxuICAgIHB1YmxpYyBwcm9jZXNzKFxyXG4gICAgICAgIGJvYXJkOiBCb2FyZCxcclxuICAgICAgICBzb3VyY2VQaWVjZTogUGllY2UsXHJcbiAgICAgICAgZGVzdFBvaW50OiBQb2ludCxcclxuICAgICAgICBkZXN0UGllY2U/OiBQaWVjZVxyXG4gICAgKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5jdXJyZW50SW5kZXggKz0gMC41O1xyXG4gICAgICAgIHRoaXMucGduICs9ICh0aGlzLmN1cnJlbnRJbmRleCAlIE1hdGguZmxvb3IodGhpcy5jdXJyZW50SW5kZXgpID09PSAwKSA/ICgnICcgKyB0aGlzLmN1cnJlbnRJbmRleCArICcuICcpIDogJyAnO1xyXG5cclxuICAgICAgICBsZXQgcG9zc2libGVDYXB0dXJlcyA9IFtdO1xyXG4gICAgICAgIGxldCBwb3NzaWJsZU1vdmVzID0gW107XHJcblxyXG4gICAgICAgIGlmIChkZXN0UGllY2UpIHtcclxuICAgICAgICAgICAgcG9zc2libGVDYXB0dXJlcyA9IE1vdmVVdGlscy5maW5kUGllY2VCeVBvc3NpYmxlQ2FwdHVyZXNDb250YWluaW5nKFxyXG4gICAgICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShkZXN0UG9pbnQsIGJvYXJkLnJldmVydGVkKSxcclxuICAgICAgICAgICAgICAgIGJvYXJkLFxyXG4gICAgICAgICAgICAgICAgc291cmNlUGllY2UuY29sb3JcclxuICAgICAgICAgICAgKS5maWx0ZXIocGllY2UgPT4gcGllY2UuY29uc3RydWN0b3IubmFtZSA9PT0gc291cmNlUGllY2UuY29uc3RydWN0b3IubmFtZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHBvc3NpYmxlTW92ZXMgPSBNb3ZlVXRpbHMuZmluZFBpZWNlQnlQb3NzaWJsZU1vdmVzQ29udGFpbmluZyhcclxuICAgICAgICAgICAgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShkZXN0UG9pbnQsIGJvYXJkLnJldmVydGVkKSxcclxuICAgICAgICAgICAgYm9hcmQsXHJcbiAgICAgICAgICAgIHNvdXJjZVBpZWNlLmNvbG9yXHJcbiAgICAgICAgKS5maWx0ZXIocGllY2UgPT4gcGllY2UuY29uc3RydWN0b3IubmFtZSA9PT0gc291cmNlUGllY2UuY29uc3RydWN0b3IubmFtZSk7XHJcblxyXG4gICAgICAgIGlmIChzb3VyY2VQaWVjZSBpbnN0YW5jZW9mIFBhd24gJiYgIWRlc3RQaWVjZSAmJiBwb3NzaWJsZUNhcHR1cmVzLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnBnbiArPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKGRlc3RQb2ludCwgYm9hcmQucmV2ZXJ0ZWQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGlmIChzb3VyY2VQaWVjZSBpbnN0YW5jZW9mIFBhd24gJiYgZGVzdFBpZWNlKSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBnbiArPSBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICApLnN1YnN0cmluZygwLCAxKSArICd4JyArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNvdXJjZVBpZWNlIGluc3RhbmNlb2YgS2luZyAmJiAoTWF0aC5hYnMoc291cmNlUGllY2UucG9pbnQuY29sIC0gZGVzdFBvaW50LmNvbCkgPT09IDIpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGJvYXJkLnJldmVydGVkKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGduICs9IGRlc3RQb2ludC5jb2wgPCAyXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA/ICdPLU8nXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA6ICdPLU8tTyc7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gZGVzdFBvaW50LmNvbCA8IDNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gJ08tTy1PJ1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiAnTy1PJztcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghKHNvdXJjZVBpZWNlIGluc3RhbmNlb2YgUGF3bikgJiYgcG9zc2libGVDYXB0dXJlcy5sZW5ndGggPT09IDAgJiYgcG9zc2libGVNb3Zlcy5sZW5ndGggPCAyKSB7ICAgICAvLyBOZjNcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2Uoc291cmNlUGllY2UpICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBvc3NpYmxlTW92ZXMgJiYgcG9zc2libGVNb3Zlcy5sZW5ndGggPT09IDIgJiYgcG9zc2libGVDYXB0dXJlcy5sZW5ndGggPT09IDApIHsgICAgLy8gTmJkN1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNFcXVhbEJ5Q29sKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvc3NpYmxlTW92ZXNbMF0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVNb3Zlc1sxXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGduICs9IE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZSkgKyBNb3ZlVXRpbHMucmV2ZXJzZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LnJvd1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkgKyBNb3ZlVXRpbHMuZm9ybWF0U2luZ2xlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0UG9pbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlKSArIE1vdmVVdGlscy5mb3JtYXRDb2woXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZS5wb2ludC5jb2xcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVzdFBvaW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocG9zc2libGVDYXB0dXJlcy5sZW5ndGggPiAxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCh0aGlzLmlzRXF1YWxCeUNvbChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVDYXB0dXJlc1swXSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9zc2libGVDYXB0dXJlc1sxXVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICkpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGduICs9IE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlUGllY2UpICsgTW92ZVV0aWxzLnJldmVyc2UoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlLnBvaW50LnJvd1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApICsgJ3gnICsgTW92ZVV0aWxzLmZvcm1hdFNpbmdsZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvYXJkLnJldmVydGVkXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZSkgKyBNb3ZlVXRpbHMuZm9ybWF0Q29sKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9hcmQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzb3VyY2VQaWVjZS5wb2ludC5jb2xcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSArICd4JyArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXN0UG9pbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBib2FyZC5yZXZlcnRlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wZ24gKz0gTW92ZVV0aWxzLmdldEZpcnN0TGV0dGVyUGllY2UoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNvdXJjZVBpZWNlKSArICd4JyArIE1vdmVVdGlscy5mb3JtYXRTaW5nbGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRlc3RQb2ludCwgYm9hcmQucmV2ZXJ0ZWRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnBnbiA9IHRoaXMucGduLnRyaW0oKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHJlc29sdmVQaWVjZUJ5Rmlyc3RDaGFyKG1vdmU6IHN0cmluZywgcGllY2U6IFBpZWNlKSB7XHJcbiAgICAgICAgcmV0dXJuIE1vdmVVdGlscy5nZXRGaXJzdExldHRlclBpZWNlKHBpZWNlKSA9PT0gbW92ZTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGlzRXF1YWxCeUNvbChhUGllY2U6IFBpZWNlLCBiUGllY2U6IFBpZWNlKSB7XHJcbiAgICAgICAgcmV0dXJuIGFQaWVjZS5wb2ludC5jb2wgPT09IGJQaWVjZS5wb2ludC5jb2w7XHJcbiAgICB9XHJcblxyXG59XHJcbiJdfQ==